import type { PluginModule } from 'napcat-types/napcat-onebot/network/plugin/types';
import { EventType } from 'napcat-types/napcat-onebot/event/index';
import type { OB11PostSendMsg } from 'napcat-types/napcat-onebot';
import type { NapCatPluginContext } from 'napcat-types/napcat-onebot/network/plugin/types';
import { pluginState } from './state';
import { pokeMessage } from './message';


export const plugin_init: PluginModule['plugin_init'] = async (ctx) => {
    ctx.logger.log('My Plugin has been initialized!');
};

export const plugin_onevent: PluginModule['plugin_onevent'] = async (ctx, event) => {
    if (event.post_type === EventType.NOTICE) {
        const notice = event as any;

        if (notice.sub_type === 'poke' && notice.self_id === notice.target_id) {
            if ('group_id' in event) {
                sendGroupMessage(ctx, notice.group_id, getPokeReply());
            } else {
                sendPrivateMessage(ctx, notice.user_id, getPokeReply());
            }
        }
    }
};

function getPokeReply() {
    return pokeMessage[Math.floor(Math.random() * pokeMessage.length)];
}

/**
 * 发送群消息
 */
export async function sendGroupMessage(
    ctx: NapCatPluginContext,
    groupId: number | string,
    message: OB11PostSendMsg['message']
): Promise<boolean> {
    try {
        const params: OB11PostSendMsg = {
            message,
            message_type: 'group',
            group_id: String(groupId),
        };
        await ctx.actions.call('send_msg', params, ctx.adapterName, ctx.pluginManager.config);
        return true;
    } catch (error) {
        pluginState.logger.error('发送群消息失败:', error);
        return false;
    }
}

/**
 * 发送私聊消息
 */
export async function sendPrivateMessage(
    ctx: NapCatPluginContext,
    userId: number | string,
    message: OB11PostSendMsg['message']
): Promise<boolean> {
    try {
        const params: OB11PostSendMsg = {
            message,
            message_type: 'private',
            user_id: String(userId),
        };
        await ctx.actions.call('send_msg', params, ctx.adapterName, ctx.pluginManager.config);
        return true;
    } catch (error) {
        pluginState.logger.error('发送私聊消息失败:', error);
        return false;
    }
}
